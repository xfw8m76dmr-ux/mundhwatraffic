name: Publish Web Story Hourly

on:
  schedule:
    - cron: "10 * * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Create AMP Web Story
        run: |
          python3 - <<'PY'
          from datetime import datetime
          ts = datetime.utcnow().strftime('%Y%m%d%H')
          title = f"Mundhwa Live â€” {datetime.utcnow().strftime('%Y-%m-%d %H:00 UTC')}"
          video_url = "https://mundhwatraffic.com/assets/mundhwa_live_short.mp4"
          html = f"""<!doctype html>
          <html amp>
          <head>
            <meta charset="utf-8">
            <title>{title}</title>
            <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
            <script async src="https://cdn.ampproject.org/v0.js"></script>
            <script async custom-element="amp-story" src="https://cdn.ampproject.org/v0/amp-story-1.0.js"></script>
          </head>
          <body>
            <amp-story standalone
              title="{title}"
              publisher="MundhwaTraffic"
              publisher-logo-src="/assets/logo.png"
              poster-portrait-src="/assets/default_poster.jpg">
              <amp-story-page id="p1">
                <amp-story-grid-layer template="fill">
                  <amp-video autoplay loop layout="responsive"
                    width="720" height="1280"
                    poster="/assets/default_poster.jpg"
                    src="{video_url}">
                  </amp-video>
                </amp-story-grid-layer>
              </amp-story-page>
            </amp-story>
          </body>
          </html>"""
          import os
          os.makedirs("stories", exist_ok=True)
          with open(f"stories/{ts}.html", "w") as f:
              f.write(html)
          PY

      - name: Commit changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"
          git add stories/
          git commit -m "Add story" || true
          git push
